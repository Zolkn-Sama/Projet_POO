<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Profil Loueur - EasyLoc</title>

    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
        * {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>

<body class="min-h-screen bg-base-200">

    <div class="navbar bg-base-100 shadow-sm border-b border-base-300 sticky top-0 z-20">
        <div class="flex-1 px-4">
            <a th:href="@{/}" class="btn btn-ghost normal-case text-xl font-bold gap-2">
                <span class="text-primary text-2xl">üöó</span>
                <span>EasyLoc</span>
            </a>
        </div>
        <div class="flex-none gap-4 px-4 items-center">
            <a th:href="@{/dashboard-agent}" class="btn btn-outline btn-sm">
                Espace Agent
            </a>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div id="avatar-initials"
                        class="bg-primary text-primary-content rounded-full w-10 flex items-center justify-center font-bold">
                        --
                    </div>
                </div>
                <ul tabindex="0"
                    class="mt-3 z-10 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li><a th:href="@{/profil}">Mon profil</a></li>
                    <li><a th:href="@{/logout}">D√©connexion</a></li>
                </ul>
            </div>
            <ul tabindex="0" class="mt-3 z-10 p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                <li><a>Mon profil</a></li>
                <li><a class="text-error font-semibold" onclick="logout()">D√©connexion</a></li>
            </ul>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">

        <section class="card bg-base-100 shadow-xl border border-base-300 overflow-hidden">
            <div
                class="card-body flex flex-col md:flex-row gap-8 items-center md:items-center text-center md:text-left">
                <div class="avatar">
                    <div
                        class="bg-neutral text-neutral-content rounded-full w-28 ring ring-primary ring-offset-base-100 ring-offset-2 flex items-center justify-center">
                        <span id="profile-initials" class="text-4xl font-bold">--</span>
                    </div>
                </div>
                <div class="flex-1 space-y-2">
                    <div class="flex flex-col gap-1">
                        <h1 id="loueur-nom-header" class="text-2xl md:text-3xl font-extrabold italic">Chargement...</h1>
                        <p class="text-sm text-base-content/70 italic">Conducteur v√©rifi√© ‚Ä¢ Membre EasyLoc</p>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center md:justify-start pt-2">
                        <div class="badge badge-primary gap-1 font-semibold">‚≠ê 4.9 <span
                                class="text-xs opacity-80">(Score)</span></div>
                        <div id="stat-nb-locations" class="badge badge-outline">0 location</div>
                        <div class="badge badge-ghost gap-1">‚úÖ Profil v√©rifi√©</div>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <button class="btn btn-primary btn-sm" th:href="@{/profil}">Modifier mon profil</button>
                </div>
            </div>
        </section>

        <aside class="space-y-6 lg:col-span-1">

            <div class="card bg-base-100 shadow-md border border-base-300">
                <div class="card-body space-y-4">
                    <h2 class="text-lg font-bold">Mes coordonn√©es</h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start gap-3">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-base-200">üìß</span>
                            <div>
                                <div class="text-xs uppercase text-base-content/60 font-semibold">Email</div>
                                <div id="loueur-email" class="font-medium break-all text-primary">...</div>
                            </div>
                            <div class="flex items-start gap-3">
                                <span
                                    class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-base-200">üìç</span>
                                <div>
                                    <div class="text-xs uppercase text-base-content/60 font-semibold">Localisation</div>
                                    <div id="loueur-ville" class="text-sm">...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="card bg-gradient-to-br from-success/10 via-base-100 to-base-100 shadow-md border border-success/30">
                    <div class="card-body space-y-4">
                        <h2 class="text-success font-bold text-lg flex items-center gap-2">üí∞ Mon Compte</h2>
                        <div class="pt-3 flex items-center justify-between">
                            <div>
                                <div class="text-[10px] uppercase font-bold text-success/70">Solde disponible</div>
                                <div id="loueur-solde" class="text-2xl font-black text-success">0.00 ‚Ç¨</div>
                            </div>
                            <button class="btn btn-sm btn-outline btn-success italic">Cr√©diter</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ AJOUT : PARRAINAGE LOUEUR -->
            <div class="card bg-base-100 shadow-md border border-base-300">
                <div class="card-body space-y-4">
                    <h2 class="text-lg font-bold">Parrainage Loueur</h2>

                    <!-- G√©n√©rer un code -->
                    <div class="bg-base-200 p-3 rounded-xl border border-base-300">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <p class="text-xs font-semibold">Cr√©er mon code</p>
                                <p class="text-[11px] opacity-60">Invite un nouveau loueur et gagne une r√©compense.</p>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="generateLoueurCode()">G√©n√©rer</button>
                        </div>

                        <div id="loueur-code-zone" class="mt-3 hidden">
                            <div class="flex items-center gap-2">
                                <input id="loueur-code" class="input input-bordered input-sm w-full font-mono" readonly value="" />
                                <button class="btn btn-ghost btn-sm" onclick="copyLoueurCode()">Copier</button>
                            </div>
                            <p id="loueur-code-status" class="text-[11px] opacity-60 mt-2"></p>
                        </div>
                    </div>

                    <!-- Utiliser un code -->
                    <div class="bg-base-200 p-3 rounded-xl border border-base-300">
                        <p class="text-xs font-semibold">J‚Äôai un code</p>
                        <p class="text-[11px] opacity-60 mb-2">Colle le code pour √™tre li√© comme filleul.</p>
                        <div class="flex items-center gap-2">
                            <input id="loueur-filleul-code" class="input input-bordered input-sm w-full font-mono"
                                   placeholder="xxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
                            <button class="btn btn-secondary btn-sm" onclick="useLoueurCode()">Valider</button>
                        </div>
                        <p id="loueur-filleul-msg" class="text-[11px] opacity-60 mt-2"></p>
                    </div>

                    <!-- V√©rifier r√©compense -->
                    <div class="bg-base-200 p-3 rounded-xl border border-base-300">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <p class="text-xs font-semibold">V√©rifier la r√©compense</p>
                                <p class="text-[11px] opacity-60">
                                    Si tu as une location termin√©e, le parrain sera cr√©dit√©.
                                </p>
                            </div>
                            <button class="btn btn-accent btn-sm" onclick="verifyLoueurReward()">V√©rifier</button>
                        </div>
                        <p id="loueur-verify-msg" class="text-[11px] opacity-60 mt-2"></p>
                    </div>
                </div>
            </div>
            <!-- ‚úÖ FIN AJOUT -->

        </aside>

        <section class="lg:col-span-2 space-y-4">
            <div class="card bg-base-100 shadow-xl border border-base-300">
                <div class="card-body">
                    <h2 class="text-xl font-bold mb-4">Historique des locations</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra table-sm w-full">
                            <thead class="text-xs">
                            <tr>
                                <th>R√©f√©rence</th>
                                <th class="text-center">Dates</th>
                                <th class="text-center">Statut</th>
                                <th class="text-right">Montant</th>
                            </tr>
                            </thead>
                            <tbody id="table-locations-body" class="text-xs">
                            <tr>
                                <td colspan="4" class="text-center py-4 opacity-50 italic">Chargement...</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </section>
    </section>
</main>

<script th:inline="javascript">
    const CURRENT_LOUEUR_ID = /*[[${session.userId}]]*/ null;

    function setText(id, txt) {
        const el = document.getElementById(id);
        if (el) el.innerText = txt;
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } finally {
            window.location.href = "/login";
        }
    }

    // -------------------------
    // ‚úÖ PARRAINAGE LOUEUR
    // -------------------------
    async function generateLoueurCode() {
        if (!CURRENT_LOUEUR_ID) {
            alert("Vous devez √™tre connect√©.");
            return;
        }
        try {
            const res = await fetch(`/parrainages/loueurs/parrain/${CURRENT_LOUEUR_ID}`, { method: "POST" });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();

            document.getElementById("loueur-code-zone").classList.remove("hidden");
            document.getElementById("loueur-code").value = data.code || "";
            setText("loueur-code-status", `Code cr√©√© ‚Ä¢ R√©compense: ${data.montantRecompense ?? 10} ‚Ç¨ ‚Ä¢ Statut: ${data.statut ?? ""}`);
        } catch (e) {
            alert("Erreur g√©n√©ration code : " + e.message);
        }
    }

    function copyLoueurCode() {
        const input = document.getElementById("loueur-code");
        if (!input || !input.value) return;

        navigator.clipboard.writeText(input.value)
            .then(() => setText("loueur-code-status", "‚úÖ Code copi√© dans le presse-papier"))
            .catch(() => setText("loueur-code-status", "‚ö†Ô∏è Copie automatique impossible"));
    }

    async function useLoueurCode() {
        if (!CURRENT_LOUEUR_ID) {
            alert("Vous devez √™tre connect√©.");
            return;
        }

        const code = document.getElementById("loueur-filleul-code").value.trim();
        if (!code) {
            setText("loueur-filleul-msg", "‚ö†Ô∏è Saisis un code.");
            return;
        }

        try {
            const url = `/parrainages/loueurs/utiliser/${encodeURIComponent(code)}/filleul/${CURRENT_LOUEUR_ID}`;
            const res = await fetch(url, { method: "POST" });
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();

            setText("loueur-filleul-msg", `‚úÖ Code li√© avec succ√®s ‚Ä¢ Statut: ${data.statut ?? ""}`);
        } catch (e) {
            setText("loueur-filleul-msg", "‚ùå " + e.message);
        }
    }

    async function verifyLoueurReward() {
        if (!CURRENT_LOUEUR_ID) {
            alert("Vous devez √™tre connect√©.");
            return;
        }

        try {
            const res = await fetch(`/parrainages/loueurs/verifier/${CURRENT_LOUEUR_ID}`, { method: "POST" });
            if (!res.ok) throw new Error(await res.text());

            setText("loueur-verify-msg", "‚úÖ V√©rification envoy√©e. Si conditions remplies, le parrain sera cr√©dit√©.");
        } catch (e) {
            setText("loueur-verify-msg", "‚ùå " + e.message);
        }
    }

    // -------------------------
    // ‚úÖ DASHBOARD DATA (ton code existant)
    // -------------------------
    async function loadDashboard() {
        try {
            const response = await fetch('/loueurs/dashboard-data');
            if (!response.ok) throw new Error("Acc√®s non autoris√©");

            const data = await response.json();
            const loueur = data.profil;

            document.getElementById('loueur-nom-header').textContent = `${loueur.prenom} ${loueur.nom}`;
            document.getElementById('loueur-email').textContent = loueur.email;
            document.getElementById('loueur-ville').textContent = `${loueur.ville || 'Non renseign√©'}, ${loueur.pays || ''}`;
            document.getElementById('loueur-solde').textContent = `${loueur.solde.toFixed(2)} ‚Ç¨`;
            document.getElementById('stat-nb-locations').textContent = `${data.contrats.length} location${data.contrats.length > 1 ? 's' : ''}`;

            const ini = `${loueur.prenom.charAt(0)}${loueur.nom.charAt(0)}`.toUpperCase();
            document.getElementById('avatar-initials').textContent = ini;
            document.getElementById('profile-initials').textContent = ini;

            const tbody = document.getElementById('table-locations-body');
            tbody.innerHTML = '';

            if (data.contrats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-10 opacity-50 italic">Aucune location effectu√©e.</td></tr>';
                return;
            }

            data.contrats.forEach(c => {
                const d1 = new Date(c.dateDebut).toLocaleDateString('fr-FR');
                const d2 = new Date(c.dateFin).toLocaleDateString('fr-FR');

                let badgeColor = "badge-ghost";
                if (c.statut === "TERMINE") badgeColor = "badge-success text-white";
                if (c.statut === "EN_COURS") badgeColor = "badge-info text-white";

                tbody.innerHTML += `
                    <tr>
                        <td><div class="font-bold">#${c.id}</div></td>
                        <td class="text-center opacity-80">${d1} - ${d2}</td>
                        <td class="text-center">
                            <span class="badge ${badgeColor} badge-sm font-bold text-[10px]">‚óè ${c.statut}</span>
                        </td>
                        <td class="text-right font-mono font-bold text-primary">${c.montantTotal.toFixed(2)} ‚Ç¨</td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error("Erreur :", err);
            document.getElementById('loueur-nom-header').textContent = "Erreur de chargement";
        }

    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
