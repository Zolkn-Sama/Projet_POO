<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Historique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-contrat { transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .card-contrat:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .badge-termine { background-color: #198754; } /* Vert */
        .badge-encours { background-color: #ffc107; color: black; } /* Jaune */
    </style>
</head>
<body class="p-4">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 rounded">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">üöó LocationApp</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link active" href="/historique">Historique</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìú Mes R√©servations</h2>

        <div class="d-flex gap-2 align-items-center bg-white p-2 rounded shadow-sm">
            <label class="mb-0"><strong>ID Client :</strong></label>
            <input type="number" id="currentUserId" class="form-control form-control-sm" style="width: 80px;" value="1">
            <button class="btn btn-sm btn-primary" onclick="loadHistorique()">Charger</button>
        </div>
    </div>

    <div id="contrats-container" class="row g-4">
        <div class="col-12 text-center text-muted py-5">
            Cliquez sur "Charger" pour voir vos contrats...
        </div>
    </div>
</div>

<div class="modal fade" id="ratingAgentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">üë§ Noter l'Agent</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modalAgentId">

                <h6 class="fw-bold mb-3 text-primary">L'exp√©rience avec le propri√©taire</h6>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Accueil</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentAccueil" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Chaleureux)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Sympa)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Froid)</option>
                            <option value="1">‚≠ê (D√©sagr√©able)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Disponibilit√©</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentDispo" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Imm√©diate)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Rapide)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Normale)</option>
                            <option value="2">‚≠ê‚≠ê (Lente)</option>
                            <option value="1">‚≠ê (Aucune r√©ponse)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Professionnalisme</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentPro" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s Pro)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Carr√©)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Amateur)</option>
                            <option value="1">‚≠ê (√Ä fuir)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Commentaire</label>
                    <textarea id="commentAgent" class="form-control" rows="2" placeholder="Ex: Agent tr√®s arrangeant..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitAgentRating()">Envoyer</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Variable globale pour la modale Agent
    let agentModalInstance;

    // 1. Fonction appel√©e quand on clique sur le bouton "Agent"
    function openAgentModal(agentId) {
        if (!agentId) {
            alert("Erreur : ID de l'agent introuvable.");
            return;
        }
        document.getElementById('modalAgentId').value = agentId;

        // Reset des champs
        document.getElementById('scoreAgentAccueil').value = '5';
        document.getElementById('scoreAgentDispo').value = '5';
        document.getElementById('scoreAgentPro').value = '5';
        document.getElementById('commentAgent').value = '';

        // Ouvrir la modale Bootstrap
        const el = document.getElementById('ratingAgentModal');
        agentModalInstance = new bootstrap.Modal(el);
        agentModalInstance.show();
    }

    // 2. Fonction appel√©e quand on clique sur "Envoyer"
    async function submitAgentRating() {
        const agId = document.getElementById('modalAgentId').value;
        const comment = document.getElementById('commentAgent').value;

        const valAccueil = document.getElementById('scoreAgentAccueil').value;
        const valDispo = document.getElementById('scoreAgentDispo').value;
        const valPro = document.getElementById('scoreAgentPro').value;

        // Payload JSON
        const payload = {
            commentaire: comment,
            criteres: [
                { nom: "Accueil",         valeur: parseInt(valAccueil) },
                { nom: "Disponibilit√©",   valeur: parseInt(valDispo) },
                { nom: "Professionnalisme", valeur: parseInt(valPro) }
            ]
        };

        console.log("Envoi note Agent:", payload);

        try {
            const resp = await fetch(`/api/notes-agent/${agId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert("‚úÖ Merci ! L'agent a √©t√© not√©.");
                agentModalInstance.hide();
            } else {
                const err = await resp.text();
                alert("‚ùå Erreur serveur : " + err);
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå Erreur r√©seau.");
        }
    }
</script>

<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">‚≠ê Noter la location</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modalVehiculeId">

                <h6 class="text-primary fw-bold mb-3">üöó D√©tails de l'√©valuation</h6>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">Propret√©</label>
                    <div class="col-sm-8">
                        <select id="scoreProprete" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Parfait)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s propre)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Sale)</option>
                            <option value="1">‚≠ê (Inacceptable)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">Confort</label>
                    <div class="col-sm-8">
                        <select id="scoreConfort" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Confortable)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bien)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Inconfortable)</option>
                            <option value="1">‚≠ê (Horrible)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">√âtat M√©canique</label>
                    <div class="col-sm-8">
                        <select id="scoreEtat" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bon)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Bruits mineurs)</option>
                            <option value="2">‚≠ê‚≠ê (Probl√®mes)</option>
                            <option value="1">‚≠ê (Dangereux)</option>
                        </select>
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label">Commentaire global</label>
                    <textarea id="commentVehicule" class="form-control" rows="2" placeholder="Ex: Voiture agr√©able mais un peu sale..."></textarea>
                </div>

                <div class="alert alert-light border small text-muted">
                    ‚ÑπÔ∏è Ces crit√®res aideront les futurs locataires et l'agence.
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" onclick="submitRating()">Envoyer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ============================================================
    // 1. CHARGER L'HISTORIQUE (VERSION R√âELLE AVEC FETCH)
    // ============================================================
    async function loadHistorique() {
        const container = document.getElementById('contrats-container');
        // R√©cup√©rer l'ID de l'utilisateur depuis l'input
        const userId = document.getElementById('currentUserId').value;

        // Afficher une animation de chargement (Spinner)
        container.innerHTML = '<div class="text-center w-100"><div class="spinner-border text-primary"></div></div>';

        try {
            console.log(`üì° Envoi de la requ√™te vers: /contrats/loueur/${userId}`);

            // 1. Appel r√©el au Backend Java (Spring Boot)
            const response = await fetch(`/contrats/loueur/${userId}`);

            // V√©rifier si la requ√™te a r√©ussi (Code 200 OK)
            if (!response.ok) {
                throw new Error("Erreur HTTP: " + response.status);
            }

            // 2. Conversion de la r√©ponse en JSON
            // C'est ici que nous recevons 'agentIdPourNote' envoy√© par le Service Java
            const contrats = await response.json();

            console.log("‚úÖ Donn√©es re√ßues du serveur:", contrats);

            // 3. Affichage dynamique des contrats sur la page
            renderContrats(contrats);

        } catch (e) {
            console.error("‚ùå Erreur lors du chargement:", e);
            // Afficher un message d'erreur visible pour l'utilisateur
            container.innerHTML = `
            <div class="alert alert-danger w-100">
                Impossible de charger l'historique. V√©rifiez que le serveur est lanc√©.<br>
                <small>D√©tail : ${e.message}</small>
            </div>`;
        }
    }
    // ============================================================
    // 2. AFFICHER LES CARTES (Render)
    // ============================================================
    function renderContrats(contrats) {
        const container = document.getElementById('contrats-container');
        container.innerHTML = '';

        if (contrats.length === 0) {
            container.innerHTML = '<div class="alert alert-info w-100 text-center">Aucun historique disponible.</div>';
            return;
        }

        contrats.forEach(c => {
            const isFinished = (c.statut === 'TERMINE' || c.statut === 'CLOTURE');

            let statusBadge = isFinished
                ? '<span class="badge badge-termine">Termin√©e</span>'
                : '<span class="badge badge-encours">En cours</span>';

            let actionButton = '';
            if (isFinished) {
                // ‚úÖ Utilisation du nouveau champ envoy√© par le backend
                // Assurez-vous que le nom correspond exactement au getter Java (getAgentIdPourNote -> agentIdPourNote)
                const agentId = c.agentIdPourNote;

                actionButton = `
        <div class="d-flex gap-2 mt-3 w-100">
            <button class="btn btn-outline-primary flex-fill"
                    onclick="openModal(${c.vehiculeId})">
                üöó V√©hicule
            </button>

            <button class="btn btn-outline-dark flex-fill"
                    onclick="openAgentModal(${agentId})">
                üë§ Agent
            </button>
        </div>`;
            }

            const d1 = new Date(c.dateDebut).toLocaleDateString();
            const d2 = new Date(c.dateFin).toLocaleDateString();

            const cardHtml = `
                <div class="col-md-6 col-lg-4">
                    <div class="card card-contrat h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title text-primary mb-0">Contrat #${c.id}</h5>
                                ${statusBadge}
                            </div>

                            <ul class="list-unstyled mb-0 small">
                                <li class="mb-1"><strong>üöó V√©hicule ID :</strong> ${c.vehiculeId}</li>
                                <li class="mb-1"><strong>üìÖ Du :</strong> ${d1}</li>
                                <li class="mb-1"><strong>üìÖ Au :</strong> ${d2}</li>
                                <li class="mb-1"><strong>üìç Lieu :</strong> ${c.lieuPrise}</li>
                                <li class="mt-2 pt-2 border-top"><strong>üí∞ Total :</strong> ${c.montantTotal} ‚Ç¨</li>
                            </ul>

                            ${actionButton}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        });
    }

    // ============================================================
    // 3. GESTION DE LA MODALE
    // ============================================================
    let ratingModal;

    function openModal(vehiculeId) {
        document.getElementById('modalVehiculeId').value = vehiculeId;

        // R√©initialiser le formulaire √† chaque ouverture
        document.getElementById('scoreProprete').value = '5';
        document.getElementById('scoreConfort').value = '5';
        document.getElementById('scoreEtat').value = '5';
        document.getElementById('commentVehicule').value = '';

        const el = document.getElementById('ratingModal');
        ratingModal = new bootstrap.Modal(el);
        ratingModal.show();
    }

    // ============================================================
    // 4. ENVOYER LA NOTE (POST - VERSION MULTI-CRIT√àRES)
    // ============================================================
    async function submitRating() {
        const vId = document.getElementById('modalVehiculeId').value;
        const comment = document.getElementById('commentVehicule').value;

        // R√©cup√©rer les valeurs des trois crit√®res
        const valProprete = document.getElementById('scoreProprete').value;
        const valConfort = document.getElementById('scoreConfort').value;
        const valEtat = document.getElementById('scoreEtat').value;

        // üü¢ Construction de l'objet JSON (Payload)
        // La structure correspond √† l'entit√© Note (NoteVehicule) contenant une liste de NoteCritere
        const payload = {
            commentaire: comment,
            criteres: [
                { nom: "Propret√©",       valeur: parseInt(valProprete) },
                { nom: "Confort",        valeur: parseInt(valConfort) },
                { nom: "√âtat M√©canique", valeur: parseInt(valEtat) }
            ]
        };

        console.log("Envoi du payload :", JSON.stringify(payload));

        try {
            const resp = await fetch(`/api/notes-vehicule/${vId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert("‚úÖ Merci ! Vos √©valuations d√©taill√©es ont √©t√© enregistr√©es.");
                ratingModal.hide();
            } else {
                const errText = await resp.text();
                // Affiche l'erreur si le v√©hicule n'existe pas ou si le serveur √©choue
                console.error("Erreur serveur:", errText);
                alert("‚ùå Erreur lors de l'enregistrement. V√©rifiez que l'ID du v√©hicule existe.");
            }
        } catch (e) {
            console.error(e);
            alert("‚ùå Erreur de connexion.");
        }
    }
</script>

</body>
</html>