<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Mon Historique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-contrat { transition: transform 0.2s; border-left: 5px solid #0d6efd; }
        .card-contrat:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .badge-termine { background-color: #198754; } /* Vert */
        .badge-encours { background-color: #ffc107; color: black; } /* Jaune */
    </style>
</head>
<body class="p-4">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 rounded">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">üöó EasyLoc</a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="/profil">Mon Profil</a></li>
                <li class="nav-item"><a class="nav-link active" href="#">Historique</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìú Mes R√©servations</h2>

        <div class="d-flex gap-2 align-items-center bg-white p-2 rounded shadow-sm">
            <label class="mb-0"><strong>ID Client :</strong></label>
            <input type="number" id="currentUserId" class="form-control form-control-sm" style="width: 80px;"
                   th:value="${userId}" placeholder="ID">
            <button class="btn btn-sm btn-primary" onclick="loadHistorique()">Charger</button>
        </div>
    </div>

    <div id="contrats-container" class="row g-4">
        <div class="col-12 text-center text-muted py-5">
            Chargement des donn√©es...
        </div>
    </div>
</div>

<div class="modal fade" id="ratingAgentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">üë§ Noter l'Agent</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modalAgentId">

                <h6 class="fw-bold mb-3 text-primary">L'exp√©rience avec le propri√©taire</h6>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Accueil</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentAccueil" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Chaleureux)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Sympa)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Froid)</option>
                            <option value="1">‚≠ê (D√©sagr√©able)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Disponibilit√©</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentDispo" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Imm√©diate)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Rapide)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Normale)</option>
                            <option value="2">‚≠ê‚≠ê (Lente)</option>
                            <option value="1">‚≠ê (Aucune r√©ponse)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-5 col-form-label">Professionnalisme</label>
                    <div class="col-sm-7">
                        <select id="scoreAgentPro" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s Pro)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Carr√©)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Amateur)</option>
                            <option value="1">‚≠ê (√Ä fuir)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Commentaire</label>
                    <textarea id="commentAgent" class="form-control" rows="2" placeholder="Ex: Agent tr√®s arrangeant..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitAgentRating()">Envoyer</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">‚≠ê Noter la location</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="modalVehiculeId">

                <h6 class="text-primary fw-bold mb-3">üöó D√©tails de l'√©valuation</h6>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">Propret√©</label>
                    <div class="col-sm-8">
                        <select id="scoreProprete" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Parfait)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s propre)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Sale)</option>
                            <option value="1">‚≠ê (Inacceptable)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">Confort</label>
                    <div class="col-sm-8">
                        <select id="scoreConfort" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Confortable)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bien)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Inconfortable)</option>
                            <option value="1">‚≠ê (Horrible)</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3 row align-items-center">
                    <label class="col-sm-4 col-form-label">√âtat M√©canique</label>
                    <div class="col-sm-8">
                        <select id="scoreEtat" class="form-select form-select-sm">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bon)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Bruits mineurs)</option>
                            <option value="2">‚≠ê‚≠ê (Probl√®mes)</option>
                            <option value="1">‚≠ê (Dangereux)</option>
                        </select>
                    </div>
                </div>

                <hr>

                <div class="mb-3">
                    <label class="form-label">Commentaire global</label>
                    <textarea id="commentVehicule" class="form-control" rows="2" placeholder="Ex: Voiture agr√©able mais un peu sale..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" onclick="submitRating()">Envoyer</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Variables globales pour les instances de modal Bootstrap
    let agentModalInstance;
    let ratingModalInstance;

    // --- 1. Ouverture des Modales ---
    function openAgentModal(agentId) {
        document.getElementById('modalAgentId').value = agentId;
        // Reset des valeurs
        document.getElementById('scoreAgentAccueil').value = '5';
        document.getElementById('scoreAgentDispo').value = '5';
        document.getElementById('scoreAgentPro').value = '5';
        document.getElementById('commentAgent').value = '';

        const el = document.getElementById('ratingAgentModal');
        agentModalInstance = new bootstrap.Modal(el);
        agentModalInstance.show();
    }

    function openModal(vehiculeId) {
        document.getElementById('modalVehiculeId').value = vehiculeId;
        // Reset des valeurs
        document.getElementById('scoreProprete').value = '5';
        document.getElementById('scoreConfort').value = '5';
        document.getElementById('scoreEtat').value = '5';
        document.getElementById('commentVehicule').value = '';

        const el = document.getElementById('ratingModal');
        ratingModalInstance = new bootstrap.Modal(el);
        ratingModalInstance.show();
    }

    // --- 2. Chargement de l'Historique ---
    async function loadHistorique() {
        const container = document.getElementById('contrats-container');
        const userId = document.getElementById('currentUserId').value;

        if(!userId) {
            container.innerHTML = '<div class="alert alert-warning text-center">Aucun ID utilisateur fourni.</div>';
            return;
        }

        container.innerHTML = '<div class="text-center w-100"><div class="spinner-border text-primary"></div></div>';

        try {
            // Appel √† l'API REST
            const response = await fetch(`/contrats/loueur/${userId}`);

            if (!response.ok) throw new Error("Erreur HTTP: " + response.status);

            const contrats = await response.json();
            renderContrats(contrats);

        } catch (e) {
            console.error("Erreur:", e);
            container.innerHTML = `<div class="alert alert-danger w-100">Erreur de chargement: ${e.message}</div>`;
        }
    }

    // --- 3. Affichage (Render) ---
    function renderContrats(contrats) {
        const container = document.getElementById('contrats-container');
        container.innerHTML = '';

        if (!contrats || contrats.length === 0) {
            container.innerHTML = '<div class="alert alert-info w-100 text-center">Aucun historique disponible.</div>';
            return;
        }

        contrats.forEach(c => {
            const isFinished = (c.statut === 'TERMINE' || c.statut === 'CLOTURE');
            let statusBadge = isFinished
                ? '<span class="badge badge-termine">Termin√©e</span>'
                : `<span class="badge badge-encours">${c.statut}</span>`;

            let buttons = '';
            if (isFinished) {
                // Adaptateur pour r√©cup√©rer les IDs (V√©rifie si ton JSON renvoie vehiculeId ou vehicule.id)
                const vId = c.vehiculeId || (c.vehicule ? c.vehicule.id : null);
                // Utilise agentIdPourNote comme dans ton code original
                const aId = c.agentIdPourNote || (c.loueur ? c.loueur.id : null);

                buttons = `
                <div class="d-flex gap-2 mt-3 w-100">
                    <button class="btn btn-outline-primary flex-fill btn-sm" onclick="openModal(${vId})">
                        üöó Noter V√©hicule
                    </button>
                    <button class="btn btn-outline-dark flex-fill btn-sm" onclick="openAgentModal(${aId})">
                        üë§ Noter Agent
                    </button>
                </div>`;
            }

            // Formatage dates
            const d1 = new Date(c.dateDebut).toLocaleDateString('fr-FR');
            const d2 = new Date(c.dateFin).toLocaleDateString('fr-FR');

            const html = `
                <div class="col-md-6 col-lg-4">
                    <div class="card card-contrat h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title text-primary mb-0">Contrat #${c.id}</h5>
                                ${statusBadge}
                            </div>
                            <ul class="list-unstyled mb-0 small">
                                <li><strong>üìÖ Dates :</strong> ${d1} au ${d2}</li>
                                <li><strong>üìç Lieu :</strong> ${c.lieuPrise || 'N/A'}</li>
                                <li class="mt-2 pt-2 border-top"><strong>üí∞ Montant :</strong> ${c.montantTotal} ‚Ç¨</li>
                            </ul>
                            ${buttons}
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // --- 4. Soumission Notations (R√âTABLISSEMENT COMPLET) ---

    // ‚úÖ Envoi Note AGENT (3 crit√®res)
    async function submitAgentRating() {
        const agId = document.getElementById('modalAgentId').value;
        const comment = document.getElementById('commentAgent').value;
        const valAccueil = document.getElementById('scoreAgentAccueil').value;
        const valDispo = document.getElementById('scoreAgentDispo').value;
        const valPro = document.getElementById('scoreAgentPro').value;

        const payload = {
            commentaire: comment,
            criteres: [
                { nom: "Accueil",         valeur: parseInt(valAccueil) },
                { nom: "Disponibilit√©",   valeur: parseInt(valDispo) },
                { nom: "Professionnalisme", valeur: parseInt(valPro) }
            ]
        };

        console.log("Envoi note Agent:", payload);

        try {
            const resp = await fetch(`/api/notes-agent/${agId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert("‚úÖ Merci ! L'agent a √©t√© not√©.");
                if(agentModalInstance) agentModalInstance.hide();
            } else {
                alert("‚ùå Erreur serveur : " + await resp.text());
            }
        } catch (e) {
            alert("‚ùå Erreur r√©seau.");
        }
    }

    // ‚úÖ Envoi Note V√âHICULE (3 crit√®res)
    async function submitRating() {
        const vId = document.getElementById('modalVehiculeId').value;
        const comment = document.getElementById('commentVehicule').value;
        const valProprete = document.getElementById('scoreProprete').value;
        const valConfort = document.getElementById('scoreConfort').value;
        const valEtat = document.getElementById('scoreEtat').value;

        const payload = {
            commentaire: comment,
            criteres: [
                { nom: "Propret√©",       valeur: parseInt(valProprete) },
                { nom: "Confort",        valeur: parseInt(valConfort) },
                { nom: "√âtat M√©canique", valeur: parseInt(valEtat) }
            ]
        };

        console.log("Envoi note V√©hicule:", payload);

        try {
            const resp = await fetch(`/api/notes-vehicule/${vId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert("‚úÖ Merci ! √âvaluation v√©hicule enregistr√©e.");
                if(ratingModalInstance) ratingModalInstance.hide();
            } else {
                alert("‚ùå Erreur : " + await resp.text());
            }
        } catch (e) {
            alert("‚ùå Erreur connexion.");
        }
    }

    // --- ‚úÖ 5. AUTO-LOAD (D√©marrage auto si ID pr√©sent) ---
    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('currentUserId');
        // Si l'input a une valeur (inject√©e par Thymeleaf), on charge direct !
        if (input && input.value) {
            console.log("ID d√©tect√©, chargement automatique...");
            loadHistorique();
        }
    });

</script>

</body>
</html>