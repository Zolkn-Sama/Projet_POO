<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon historique - EasyLoc</title>

    <!-- Tailwind + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />

    <style>
        * {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-base-200 via-base-200 to-base-300">

    <!-- NAVBAR -->
    <div class="navbar bg-base-100 shadow-sm px-4 sticky top-0 z-30">
        <div class="flex-1">
            <a th:href="@{/}" href="/" class="btn btn-ghost text-xl font-bold gap-2">
                <span class="text-2xl">üöó</span>
                <span>EasyLoc</span>
            </a>
        </div>
        <div class="flex-none gap-4 px-4 items-center">
            <a th:href="@{/dashboard-agent}" class="btn btn-outline btn-sm">Espace Agent</a>
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div id="avatar-initials"
                        class="bg-primary text-primary-content rounded-full w-10 flex items-center display-flex justify-center font-bold"
                        style="display: flex;">
                        --</div>
                </div>
                <ul tabindex="0"
                    class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li><a class="dropdown-item" th:href="@{/profil}">Mon Profil</a></li>
                    <li><a class="text-error font-semibold" onclick="logout()">D√©connexion</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">

        <!-- HEADER / INTRO -->
        <section class="hero bg-base-100 rounded-2xl shadow-xl border border-base-300">
            <div class="hero-content flex-col lg:flex-row gap-8">
                <div class="flex-1 space-y-4">
                    <div class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.2em] font-semibold text-primary">
                            Historique de r√©servations
                        </p>
                        <h1 class="text-3xl lg:text-4xl font-extrabold leading-tight">
                            Retrouvez toutes vos locations
                            <span class="text-primary">en un coup d‚Äô≈ìil</span>
                        </h1>
                    </div>

                    <p class="text-sm text-base-content/70 max-w-xl">
                        Votre historique se charge automatiquement d√®s que vous √™tes connect√©. Consultez vos anciens
                        contrats, les montants pay√©s et laissez des avis d√©taill√©s sur les v√©hicules et les agents.
                    </p>

                    <div class="flex flex-wrap gap-2 text-xs">
                        <div class="badge badge-primary gap-1">
                            ‚≠ê Avis d√©taill√©s
                        </div>
                        <div class="badge badge-secondary gap-1">
                            üßæ Suivi des contrats
                        </div>
                        <div class="badge badge-outline gap-1">
                            üîê Espace s√©curis√©
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- CONTENU PRINCIPAL : LISTE DES CONTRATS + AIDE -->
        <section class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] items-start">

            <!-- LISTE DES CONTRATS -->
            <section class="card bg-base-100/90 backdrop-blur-sm shadow-xl border border-base-300 rounded-2xl">
                <div class="card-body">
                    <div class="flex items-center justify-between mb-4 gap-2">
                        <div class="flex items-center gap-2">
                            <span class="text-primary text-xl">üóÇ</span>
                            <div>
                                <h2 class="font-bold text-lg">Mes contrats</h2>
                                <p class="text-xs text-base-content/60">
                                    Contrats pass√©s et en cours, du plus r√©cent au plus ancien.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="contrats-container" class="grid gap-6 lg:grid-cols-1 xl:grid-cols-2">
                        <div class="col-span-full text-center text-base-content/50 py-10 text-sm">
                            Chargement automatique de votre historique en cours...
                        </div>
                    </div>
                </div>
            </section>

            <!-- COLONNE AIDE / CONSEILS -->
            <aside class="space-y-4">

                <div class="card bg-base-100 shadow-lg border border-base-300 rounded-2xl">
                    <div class="card-body space-y-3">
                        <h3 class="font-semibold text-sm flex items-center gap-2">
                            <span class="text-info">‚ÑπÔ∏è</span>
                            Comment fonctionne l‚Äôhistorique ?
                        </h3>
                        <ul class="text-xs text-base-content/70 space-y-2">
                            <li>‚Ä¢ <span class="font-semibold">En cours</span> : contrats dont la p√©riode de location
                                n‚Äôest pas termin√©e.</li>
                            <li>‚Ä¢ <span class="font-semibold">Termin√©e</span> : vous pouvez noter le v√©hicule et
                                l‚Äôagent.</li>
                            <li>‚Ä¢ Les montants affich√©s sont les <span class="font-semibold">totaux pay√©s</span> pour
                                chaque contrat.</li>
                        </ul>
                    </div>
                </div>

                <div
                    class="card bg-gradient-to-br from-primary/10 via-base-100 to-secondary/10 shadow-lg border border-base-300 rounded-2xl">
                    <div class="card-body space-y-3 text-xs">
                        <h3 class="font-semibold text-sm flex items-center gap-2">
                            <span class="text-warning">‚≠ê</span>
                            Conseils pour vos avis
                        </h3>
                        <p class="text-base-content/70">
                            Soyez pr√©cis sur la propret√©, le confort et l‚Äô√©tat m√©canique du v√©hicule. Pour l‚Äôagent,
                            mentionnez l‚Äôaccueil, la r√©activit√© et le professionnalisme.
                        </p>
                        <p class="text-base-content/60">
                            Des avis complets <span class="font-semibold">valorisent les bons loueurs</span> et
                            am√©liorent la plateforme pour tous.
                        </p>
                    </div>
                </div>

            </aside>
        </section>
    </main>

    <!-- MODALE NOTE VEHICULE -->
    <dialog id="ratingModal" class="modal">
        <div class="modal-box max-w-md">
            <form method="dialog">
                <button type="submit" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
            </form>

            <h3 class="font-bold text-lg flex items-center gap-2 mb-3">
                <span class="text-warning">‚≠ê</span>
                Noter la location
            </h3>

            <input type="hidden" id="modalVehiculeId">

            <div class="space-y-3 text-sm">
                <div>
                    <h4 class="text-primary font-semibold mb-1">üöó D√©tails de l'√©valuation</h4>
                    <p class="text-xs text-base-content/60">
                        Donnez une note √† votre exp√©rience de location pour ce v√©hicule.
                    </p>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">Propret√©</span>
                        </div>
                        <select id="scoreProprete" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Parfait)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s propre)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Sale)</option>
                            <option value="1">‚≠ê (Inacceptable)</option>
                        </select>
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">Confort</span>
                        </div>
                        <select id="scoreConfort" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Confortable)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bien)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Inconfortable)</option>
                            <option value="1">‚≠ê (Horrible)</option>
                        </select>
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">√âtat m√©canique</span>
                        </div>
                        <select id="scoreEtat" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Bon)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Bruits mineurs)</option>
                            <option value="2">‚≠ê‚≠ê (Probl√®mes)</option>
                            <option value="1">‚≠ê (Dangereux)</option>
                        </select>
                    </label>
                </div>

                <div class="divider my-2"></div>

                <label class="form-control">
                    <div class="label">
                        <span class="label-text">Commentaire global</span>
                    </div>
                    <textarea id="commentVehicule" class="textarea textarea-bordered text-sm" rows="3"
                        placeholder="Ex: Voiture agr√©able mais un peu sale..."></textarea>
                </label>

                <div class="alert alert-info text-xs mt-1">
                    ‚ÑπÔ∏è Ces crit√®res aideront les futurs locataires et l'agence √† am√©liorer le service.
                </div>
            </div>

            <div class="modal-action">
                <form method="dialog">
                    <button type="submit" class="btn btn-ghost btn-sm">Annuler</button>
                </form>
                <button type="button" class="btn btn-success btn-sm" onclick="submitRating()">
                    Envoyer
                </button>
            </div>
        </div>
    </dialog>

    <!-- MODALE NOTE AGENT -->
    <dialog id="ratingAgentModal" class="modal">
        <div class="modal-box max-w-md">
            <form method="dialog">
                <button type="submit" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">‚úï</button>
            </form>

            <h3 class="font-bold text-lg flex items-center gap-2 mb-3">
                <span>üë§</span>
                Noter l'agent
            </h3>

            <input type="hidden" id="modalAgentId">

            <div class="space-y-3 text-sm">
                <div>
                    <h4 class="text-primary font-semibold mb-1">Exp√©rience avec le propri√©taire</h4>
                    <p class="text-xs text-base-content/60">
                        Partagez votre ressenti sur l‚Äôagent : accueil, disponibilit√© et professionnalisme.
                    </p>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">Accueil</span>
                        </div>
                        <select id="scoreAgentAccueil" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Chaleureux)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Sympa)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Correct)</option>
                            <option value="2">‚≠ê‚≠ê (Froid)</option>
                            <option value="1">‚≠ê (D√©sagr√©able)</option>
                        </select>
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">Disponibilit√©</span>
                        </div>
                        <select id="scoreAgentDispo" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Imm√©diate)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Rapide)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Normale)</option>
                            <option value="2">‚≠ê‚≠ê (Lente)</option>
                            <option value="1">‚≠ê (Aucune r√©ponse)</option>
                        </select>
                    </label>

                    <label class="form-control w-full">
                        <div class="label">
                            <span class="label-text">Professionnalisme</span>
                        </div>
                        <select id="scoreAgentPro" class="select select-sm select-bordered">
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Tr√®s pro)</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Carr√©)</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê (Moyen)</option>
                            <option value="2">‚≠ê‚≠ê (Amateur)</option>
                            <option value="1">‚≠ê (√Ä fuir)</option>
                        </select>
                    </label>
                </div>

                <label class="form-control">
                    <div class="label">
                        <span class="label-text">Commentaire</span>
                    </div>
                    <textarea id="commentAgent" class="textarea textarea-bordered text-sm" rows="3"
                        placeholder="Ex: Agent tr√®s arrangeant..."></textarea>
                </label>
            </div>

            <div class="modal-action">
                <form method="dialog">
                    <button type="submit" class="btn btn-ghost btn-sm">Annuler</button>
                </form>
                <button type="button" class="btn btn-primary btn-sm" onclick="submitAgentRating()">
                    Envoyer
                </button>
            </div>
        </div>
    </dialog>

    <!-- Injection de l'ID utilisateur courant pour le JS -->
    <script th:inline="javascript">
        const CURRENT_USER_ID = /*[[${currentUser != null ? currentUser.id : null}]]*/ null;
    </script>

    <script>
        // ============================
        // RENDER DES CONTRATS
        // ============================
        function renderContrats(contrats) {
            const container = document.getElementById('contrats-container');
            const countBadge = document.getElementById('contrats-count');

            container.innerHTML = '';

            if (!Array.isArray(contrats) || contrats.length === 0) {
                container.innerHTML = `
                <div class="col-span-full alert alert-info shadow-sm text-sm">
                    Aucun historique disponible pour cet utilisateur.
                </div>
            `;
                if (countBadge) {
                    countBadge.textContent = "0 contrat";
                    countBadge.classList.remove('hidden');
                }
                return;
            }

            contrats.forEach(c => {
                const isFinished = (c.statut === 'TERMINE' || c.statut === 'CLOTURE');

                const statusBadge = isFinished
                    ? '<div class="badge badge-success badge-outline text-[11px]">Termin√©e</div>'
                    : '<div class="badge badge-warning badge-outline text-[11px]">En cours</div>';

                const borderClass = isFinished
                    ? 'border-l-4 border-l-success/70'
                    : 'border-l-4 border-l-warning/70';

                let actionButtons = '';
                if (isFinished) {
                    const agentId = c.agentIdPourNote;

                    actionButtons = `
                    <div class="mt-4 flex gap-2">
                        <button class="btn btn-xs btn-outline btn-primary flex-1 rounded-full"
                                type="button"
                                onclick="openModal(${c.vehiculeId})">
                            üöó Noter le v√©hicule
                        </button>
                        <button class="btn btn-xs btn-outline btn-neutral flex-1 rounded-full"
                                type="button"
                                onclick="openAgentModal(${agentId ?? 'null'})">
                            üë§ Noter l'agent
                        </button>
                    </div>
                `;
                }

                const d1 = c.dateDebut ? new Date(c.dateDebut).toLocaleDateString('fr-FR') : '-';
                const d2 = c.dateFin ? new Date(c.dateFin).toLocaleDateString('fr-FR') : '-';
                const lieu = c.lieuPrise || '-';

                const cardHtml = `
                <article class="card bg-base-100 shadow-md hover:shadow-xl border border-base-300 rounded-2xl transition-all duration-150 ${borderClass}">
                    <div class="card-body p-6 space-y-4">
                        <div class="flex items-center justify-between gap-2">
                            <div>
                                <h3 class="font-semibold text-lg text-base-content flex items-center gap-2">
                                    <span class="text-primary text-xl">üìÑ</span>
                                    Contrat #${c.id}
                                </h3>
                                <p class="text-[11px] text-base-content/60">
                                    V√©hicule ID : <span class="font-medium">${c.vehiculeId}</span>
                                </p>
                            </div>
                            ${statusBadge}
                        </div>

                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <span class="text-xs text-base-content/60">Du</span><br>
                                <span class="font-medium">${d1}</span>
                            </div>
                            <div>
                                <span class="text-xs text-base-content/60">Au</span><br>
                                <span class="font-medium">${d2}</span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-xs text-base-content/60">Lieu</span><br>
                                <span class="font-medium">${lieu}</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-3 border-t border-dashed border-base-300">
                            <span class="text-[11px] uppercase tracking-wide text-base-content/60">
                                Montant total
                            </span>
                            <span class="text-xl font-bold text-primary">
                                ${c.montantTotal} ‚Ç¨
                            </span>
                        </div>

                        ${actionButtons}
                    </div>
                </article>
            `;

                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // ============================
        // FETCH HISTORIQUE
        // ============================
        async function loadHistorique() {
            const container = document.getElementById('contrats-container');
            const countBadge = document.getElementById('contrats-count');

            if (CURRENT_USER_ID === null) {
                container.innerHTML = `
                <div class="col-span-full alert alert-warning shadow-sm text-sm">
                    Connectez-vous pour afficher automatiquement votre historique de r√©servations.
                </div>
            `;
                if (countBadge) countBadge.classList.add('hidden');
                return;
            }

            container.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-8">
                <span class="loading loading-spinner loading-md text-primary mb-2"></span>
                <p class="text-sm text-base-content/60">Chargement de vos contrats...</p>
            </div>
        `;
            if (countBadge) countBadge.classList.add('hidden');

            try {
                console.log(`üì° Envoi de la requ√™te vers: /contrats/loueur/${CURRENT_USER_ID}`);

                const response = await fetch(`/contrats/loueur/${encodeURIComponent(CURRENT_USER_ID)}`);

                if (!response.ok) {
                    throw new Error("Erreur HTTP: " + response.status);
                }

                const contrats = await response.json();
                console.log("‚úÖ Donn√©es re√ßues du serveur:", contrats);

                renderContrats(contrats);

                if (countBadge) {
                    countBadge.textContent =
                        contrats.length + (contrats.length > 1 ? " contrats" : " contrat");
                    countBadge.classList.remove('hidden');
                }

            } catch (e) {
                console.error("‚ùå Erreur lors du chargement:", e);
                container.innerHTML = `
                <div class="col-span-full alert alert-error shadow-sm">
                    <span>
                        Impossible de charger l'historique. V√©rifiez que le serveur est lanc√©.<br>
                        <span class="text-xs opacity-70">D√©tail : ${e.message}</span>
                    </span>
                </div>
            `;
                if (countBadge) countBadge.classList.add('hidden');
            }
        }

        // ============================
        // MODALE VEHICULE
        // ============================
        function openModal(vehiculeId) {
            if (!vehiculeId && vehiculeId !== 0) {
                alert("Erreur : ID du v√©hicule introuvable.");
                return;
            }

            document.getElementById('modalVehiculeId').value = vehiculeId;

            document.getElementById('scoreProprete').value = '5';
            document.getElementById('scoreConfort').value = '5';
            document.getElementById('scoreEtat').value = '5';
            document.getElementById('commentVehicule').value = '';

            const dialog = document.getElementById('ratingModal');
            if (dialog && typeof dialog.showModal === 'function') {
                dialog.showModal();
            } else {
                console.warn("L'√©l√©ment <dialog> n'est pas support√© par ce navigateur.");
            }
        }

        async function submitRating() {
            const vId = document.getElementById('modalVehiculeId').value;
            const comment = document.getElementById('commentVehicule').value;

            const valProprete = document.getElementById('scoreProprete').value;
            const valConfort = document.getElementById('scoreConfort').value;
            const valEtat = document.getElementById('scoreEtat').value;

            const payload = {
                commentaire: comment,
                criteres: [
                    { nom: "Propret√©", valeur: parseInt(valProprete, 10) },
                    { nom: "Confort", valeur: parseInt(valConfort, 10) },
                    { nom: "√âtat M√©canique", valeur: parseInt(valEtat, 10) }
                ]
            };

            console.log("Envoi du payload note v√©hicule :", JSON.stringify(payload));

            try {
                const resp = await fetch(`/api/notes-vehicule/${encodeURIComponent(vId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    alert("‚úÖ Merci ! Vos √©valuations d√©taill√©es ont √©t√© enregistr√©es.");
                    const dialog = document.getElementById('ratingModal');
                    if (dialog) dialog.close();
                } else {
                    const errText = await resp.text();
                    console.error("Erreur serveur:", errText);
                    alert("‚ùå Erreur lors de l'enregistrement. V√©rifiez que l'ID du v√©hicule existe.");
                }
            } catch (e) {
                console.error(e);
                alert("‚ùå Erreur de connexion.");
            }
        }

        // ============================
        // MODALE AGENT
        // ============================
        function openAgentModal(agentId) {
            if (!agentId && agentId !== 0) {
                alert("Erreur : ID de l'agent introuvable.");
                return;
            }

            document.getElementById('modalAgentId').value = agentId;
            document.getElementById('scoreAgentAccueil').value = '5';
            document.getElementById('scoreAgentDispo').value = '5';
            document.getElementById('scoreAgentPro').value = '5';
            document.getElementById('commentAgent').value = '';

            const dialog = document.getElementById('ratingAgentModal');
            if (dialog && typeof dialog.showModal === 'function') {
                dialog.showModal();
            } else {
                console.warn("L'√©l√©ment <dialog> n'est pas support√© par ce navigateur.");
            }
        }

        async function submitAgentRating() {
            const agId = document.getElementById('modalAgentId').value;
            const comment = document.getElementById('commentAgent').value;

            const valAccueil = document.getElementById('scoreAgentAccueil').value;
            const valDispo = document.getElementById('scoreAgentDispo').value;
            const valPro = document.getElementById('scoreAgentPro').value;

            const payload = {
                commentaire: comment,
                criteres: [
                    { nom: "Accueil", valeur: parseInt(valAccueil, 10) },
                    { nom: "Disponibilit√©", valeur: parseInt(valDispo, 10) },
                    { nom: "Professionnalisme", valeur: parseInt(valPro, 10) }
                ]
            };

            console.log("Envoi note Agent:", payload);

            try {
                const resp = await fetch(`/api/notes-agent/${encodeURIComponent(agId)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp.ok) {
                    alert("‚úÖ Merci ! L'agent a √©t√© not√©.");
                    const dialog = document.getElementById('ratingAgentModal');
                    if (dialog) dialog.close();
                } else {
                    const err = await resp.text();
                    console.error("Erreur serveur:", err);
                    alert("‚ùå Erreur serveur : " + err);
                }
            } catch (e) {
                console.error(e);
                alert("‚ùå Erreur r√©seau.");
            }
        }

        async function UserInit() {
            const response = await fetch('/loueurs/dashboard-data');
            if (!response.ok) throw new Error("Acc√®s non autoris√© ou erreur serveur");

            const data = await response.json();
            console.log("Donn√©es re√ßues :", data); // Pour debugger dans la console F12

            const loueur = data.profil;

            // 1. Injection des donn√©es de profil avec s√©curit√© (au cas o√π les champs sont nuls)
            const prenom = loueur.prenom || "";
            const nom = loueur.nom || "";

            const ini = ((prenom.charAt(0) || "") + (nom.charAt(0) || "")).toUpperCase() || "??";
            document.getElementById('avatar-initials').textContent = ini;


        }

        // ============================
        // LOGOUT
        // ============================
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => window.location.reload())
                .catch(err => console.error("Erreur d√©connexion:", err));
        }

        // ============================
        // AUTO-CHARGEMENT
        // ============================
        document.addEventListener('DOMContentLoaded', () => {
            loadHistorique();
            UserInit()
        });
    </script>

</body>

</html>