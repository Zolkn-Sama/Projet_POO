<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8">
    <title>D√©tails du v√©hicule - LocAuto</title>

    <!-- DaisyUI + Tailwind -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
        * {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>

<body class="bg-base-200 min-h-screen">

    <!-- NAVBAR -->
    <div class="navbar bg-base-100 shadow-sm px-4 border-b border-base-300">
        <div class="flex-1">
            <a th:href="@{/}" class="btn btn-ghost text-xl font-bold gap-2">
                <span class="text-primary text-2xl">üöó</span>
                <span>LocAuto</span>
            </a>
        </div>
        <div class="flex-none text-xs text-base-content/70">
            <span class="hidden sm:inline">Besoin d‚Äôaide ? Contactez l‚Äôagent du v√©hicule.</span>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-6 md:py-10">
        <div class="grid gap-6 lg:grid-cols-3">

            <!-- COLONNE GAUCHE : infos v√©hicule -->
            <section class="lg:col-span-2 space-y-5">

                <!-- Titre + localisation + note -->
                <div class="card bg-base-100 shadow-xl border border-base-300">
                    <div class="card-body space-y-4">
                        <div class="flex items-start justify-between gap-4">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <div class="badge badge-success badge-sm">Disponible</div>
                                    <div id="v-categorie" class="badge badge-outline badge-sm hidden"></div>
                                </div>
                                <h1 id="v-titre" class="text-2xl md:text-3xl font-black text-primary">
                                    Chargement...
                                </h1>
                                <p id="v-ville" class="text-sm md:text-base opacity-70">
                                    üìç --
                                </p>
                            </div>

                            <div class="text-right space-y-1">
                                <div class="text-xs uppercase text-base-content/60 font-semibold">
                                    Note moyenne
                                </div>
                                <div id="v-note" class="text-2xl font-bold text-secondary">
                                    --
                                </div>
                                <div class="text-[11px] text-base-content/60" id="v-nb-avis">
                                    <!-- ex : 12 avis -->
                                </div>
                            </div>
                        </div>

                        <!-- CARROUSEL D'IMAGES DU V√âHICULE -->
                        <div id="carrousel-vehicule" class="mt-4">
                            <!-- Fallback par d√©faut : affich√© tant que JS n‚Äôa pas remplac√© -->

                        </div>
                    </div>
                </div>

                <!-- Caract√©ristiques & options -->
                <div class="card bg-base-100 shadow-md border border-base-300">
                    <div class="card-body space-y-4">
                        <h2 class="text-lg font-bold">Caract√©ristiques du v√©hicule</h2>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                            <div class="bg-base-200/60 rounded-xl p-3">
                                <div class="text-xs uppercase text-base-content/60">Marque</div>
                                <div id="v-marque" class="font-semibold">--</div>
                            </div>
                            <div class="bg-base-200/60 rounded-xl p-3">
                                <div class="text-xs uppercase text-base-content/60">Mod√®le</div>
                                <div id="v-modele" class="font-semibold">--</div>
                            </div>
                            <div class="bg-base-200/60 rounded-xl p-3">
                                <div class="text-xs uppercase text-base-content/60">Couleur</div>
                                <div id="v-couleur" class="font-semibold">--</div>
                            </div>
                            <div class="bg-base-200/60 rounded-xl p-3">
                                <div class="text-xs uppercase text-base-content/60">Nombre de places</div>
                                <div id="v-places" class="font-semibold">--</div>
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between gap-2">
                                <h3 class="font-semibold text-sm">Options incluses</h3>
                                <span class="text-[11px] text-base-content/60">
                                    (GPS, climatisation, etc.)
                                </span>
                            </div>
                            <div id="v-options" class="flex flex-wrap gap-2 text-xs">
                                <!-- Rempli en JS -->
                                <span class="badge badge-ghost">Chargement...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent -->
                <div class="card bg-base-100 shadow-md border border-base-300">
                    <div class="card-body flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="avatar">
                            <div
                                class="w-12 rounded-full bg-primary text-primary-content flex items-center justify-center font-bold text-sm">
                                <span id="agent-initials">AG</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs uppercase text-base-content/60 font-semibold">
                                Agent en charge
                            </div>
                            <div id="agent-nom" class="font-semibold text-sm">
                                Nom de l‚Äôagent
                            </div>
                            <div id="agent-info" class="text-xs text-base-content/60">
                                Agence et localisation
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 w-full sm:w-auto">
                            <a id="btn-contact-agent" href="/conversation" class="btn btn-outline btn-sm w-full">
                                üí¨ Contacter l‚Äôagent
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- COLONNE DROITE : r√©servation -->
            <aside class="space-y-4 lg:col-span-1">
                <div class="card bg-base-100 shadow-xl border border-primary/40">
                    <div class="card-body space-y-4">
                        <div class="flex items-center justify-between gap-2">
                            <div>
                                <div class="text-xs uppercase text-base-content/60 font-semibold">
                                    √Ä partir de
                                </div>
                                <div class="text-2xl font-extrabold text-primary">
                                    <span id="v-prix">--</span> ‚Ç¨/jour
                                </div>
                            </div>
                        </div>

                        <div class="divider my-2"></div>

                        <!-- S√©lection de la p√©riode -->
                        <div class="space-y-2">
                            <h2 class="text-sm font-semibold flex items-center gap-2">
                                S√©lectionner votre p√©riode
                            </h2>
                            <div class="grid grid-cols-1 gap-3">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text text-xs">Date de d√©part</span>
                                    </label>
                                    <input id="date-debut" type="date" class="input input-bordered input-sm w-full" />
                                </div>

                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text text-xs">Date de fin</span>
                                    </label>
                                    <input id="date-fin" type="date" class="input input-bordered input-sm w-full" />
                                </div>
                            </div>

                            <p class="text-[11px] text-base-content/60">
                                Utilisez les calendriers ci-dessus pour choisir la date de d√©but et de fin.
                                La dur√©e et le prix estimatif seront calcul√©s automatiquement.
                            </p>
                        </div>

                        <div class="divider my-2"></div>

                        <!-- R√©cap dur√©e + prix -->
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Dur√©e</span>
                                <span id="recap-duree">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Prix estim√©</span>
                                <span id="recap-prix">--</span>
                            </div>
                            <p class="text-[10px] text-base-content/60">
                                Le prix final pourra √™tre ajust√© par l‚Äôagent selon les conditions
                                (options, kilom√©trage, assurance, etc.).
                            </p>
                        </div>

                        <button id="btn-louer" class="btn btn-primary w-full mt-2" type="button" disabled>
                            ‚úÖ Continuer vers la r√©servation
                        </button>
                    </div>
                </div>

                <!-- Encadr√© infos suppl√©mentaires -->
                <div class="card bg-base-100 shadow-md border border-base-300">
                    <div class="card-body space-y-2 text-xs">
                        <div class="flex items-center gap-2">
                            <span class="text-lg">‚ÑπÔ∏è</span>
                            <h3 class="font-semibold text-sm">Bon √† savoir</h3>
                        </div>
                        <p class="text-base-content/70">
                            Les dates choisies sont soumises √† validation par l‚Äôagent. En cas d‚Äôindisponibilit√©,
                            une alternative pourra vous √™tre propos√©e via la messagerie interne.
                        </p>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <script>
        // --- Utilitaires dates ---
        function parseDateInput(value) {
            if (!value) return null;
            // value au format "YYYY-MM-DD"
            const [y, m, d] = value.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function diffDays(d1, d2) {
            const ms = d2 - d1;
            return Math.round(ms / (1000 * 60 * 60 * 24));
        }

        const titreEl = document.getElementById('v-titre');
        const villeEl = document.getElementById('v-ville');
        const marqueEl = document.getElementById('v-marque');
        const modeleEl = document.getElementById('v-modele');
        const couleurEl = document.getElementById('v-couleur');
        const placesEl = document.getElementById('v-places');
        const noteEl = document.getElementById('v-note');
        const nbAvisEl = document.getElementById('v-nb-avis');
        const optionsEl = document.getElementById('v-options');
        const prixEl = document.getElementById('v-prix');
        const agentNomEl = document.getElementById('agent-nom');
        const agentInfoEl = document.getElementById('agent-info');
        const agentInitialsEl = document.getElementById('agent-initials');
        const contactAgentBtn = document.getElementById('btn-contact-agent');

        const dateDebutInput = document.getElementById('date-debut');
        const dateFinInput = document.getElementById('date-fin');
        const recapDureeEl = document.getElementById('recap-duree');
        const recapPrixEl = document.getElementById('recap-prix');
        const btnLouer = document.getElementById('btn-louer');

        const carrouselContainer = document.getElementById('carrousel-vehicule');
        // R√©cup√©ration de l'ID dans l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const vehiculeId = urlParams.get('id');

        let prixParJour = 0;

        if (vehiculeId) {
            fetch(`/vehicules/ById/${vehiculeId}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Erreur HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(v => {
                    // --- Remplissage infos v√©hicule ---
                    const car = v.caracteristiques || {};
                    const loc = v.localisationVehicule || {};
                    titreEl.textContent = `${car.marque || ''} ${car.modele || ''}`.trim() || 'V√©hicule';
                    marqueEl.textContent = car.marque || '--';
                    modeleEl.textContent = car.modele || '--';
                    couleurEl.textContent = car.couleur || '--';
                    placesEl.textContent = car.nbPlaces || '--';
                    villeEl.textContent = loc.ville ? `üìç ${loc.ville}` : 'üìç --';

                    if (typeof v.noteMoyenne === 'number') {
                        noteEl.textContent = `‚≠ê ${v.noteMoyenne.toFixed(1)}`;
                    } else {
                        noteEl.textContent = '--';
                    }

                    if (typeof v.nbAvis === 'number') {
                        nbAvisEl.textContent = `${v.nbAvis} avis`;
                    }

                    // Prix par jour (adapter selon ta propri√©t√© r√©elle)
                    if (typeof v.prixParJour === 'number') {
                        prixParJour = v.prixParJour;
                    } else if (car.prixParJour) {
                        prixParJour = car.prixParJour;
                    }
                    prixEl.textContent = prixParJour ? prixParJour.toFixed(2) : '--';

                    // Options (adapter selon structure r√©elle : v.options ou v.optionsVehicule, etc.)
                    if (Array.isArray(v.options) && v.options.length > 0) {
                        optionsEl.innerHTML = '';
                        v.options.forEach(opt => {
                            const badge = document.createElement('span');
                            badge.className = 'badge badge-outline text-xs';
                            // opt.code / opt.libelle √† adapter selon ton mod√®le
                            badge.textContent = opt.libelle || opt.code || 'Option';
                            optionsEl.appendChild(badge);
                        });
                    } else {
                        optionsEl.innerHTML = '<span class="text-[11px] text-base-content/60">Aucune option particuli√®re renseign√©e.</span>';
                    }

                    // Agent (adapter selon ta structure : v.agent, v.loueur, v.agentResponsable, etc.)
                    const agent = v.agent || v.loueur || v.owner || null;
                    if (agent) {
                        const nomComplet = (agent.prenom ? agent.prenom + ' ' : '') + (agent.nom || '');
                        agentNomEl.textContent = nomComplet.trim() || 'Agent LocAuto';
                        agentInfoEl.textContent = agent.ville ? `Bas√© √† ${agent.ville}` : 'Agent partenaire LocAuto';

                        // Initiales
                        const initiales = ((agent.prenom || 'A')[0] + (agent.nom || 'G')[0]).toUpperCase();
                        agentInitialsEl.textContent = initiales;

                        // Lien contact (on peut passer un param√®tre, √† adapter selon ton routing)
                        if (agent.id) {
                            contactAgentBtn.href = `/conversation?with=${agent.id}`;
                        }
                    } else {
                        agentNomEl.textContent = 'Agent LocAuto';
                        agentInfoEl.textContent = 'Agent partenaire LocAuto';
                        agentInitialsEl.textContent = 'AG';
                    }

                    // ... ton code existant pour titre, marque, etc. ...

                    // üñºÔ∏è Carrousel √† partir de la liste des fragments d'URL
                    // v.photosURL contient par ex. : ["/12_Clio_1.jpeg", "/12_Clio_2.jpeg"]
                    const photos = v.photosURL || [];

                    if (!Array.isArray(photos) || photos.length === 0) {
                        // On garde le fallback üöó si pas d'image
                        return;
                    }

                    let slides = "";
                    let nav = "";

                    photos.forEach((fragment, idx) => {
                        const fullUrl = fragment.startsWith("/")
                            ? fragment
                            : "/" + fragment;

                        slides += `
                            <div id="slide${idx}" class="carousel-item relative w-full">
                                <img src="${fullUrl}"
                                        alt="Photo du v√©hicule"
                                        class="w-full h-48 md:h-60 object-cover" />
                            </div> `;

                        nav += ` <a href="#slide${idx}" class="btn btn-xs">${idx + 1}</a>`;
                    });

                    carrouselContainer.innerHTML = `
                        <div class="carousel w-full rounded-2xl overflow-hidden mb-2">
                            ${slides}
                        </div>
                        <div class="flex justify-center gap-2">
                            ${nav}
                        </div>`;

                })
                .catch(err => {
                    console.error(err);
                    titreEl.textContent = 'V√©hicule introuvable';
                });
        }

        function updateRecap() {
            const d1 = parseDateInput(dateDebutInput.value);
            const d2 = parseDateInput(dateFinInput.value);

            if (!d1 || !d2 || d2 <= d1) {
                recapDureeEl.textContent = '--';
                recapPrixEl.textContent = '--';
                btnLouer.disabled = true;
                return;
            }

            const jours = diffDays(d1, d2);
            recapDureeEl.textContent = `${jours} jour(s)`;
            if (prixParJour && !isNaN(prixParJour)) {
                const total = jours * prixParJour;
                recapPrixEl.textContent = `${total.toFixed(2)} ‚Ç¨`;
            } else {
                recapPrixEl.textContent = '--';
            }
            btnLouer.disabled = false;
        }

        dateDebutInput.addEventListener('change', updateRecap);
        dateFinInput.addEventListener('change', updateRecap);

        btnLouer.addEventListener('click', () => {
            const start = dateDebutInput.value;
            const end = dateFinInput.value;

            if (!start || !end) return;

            // Redirection vers une page de r√©servation, √† adapter selon ton contr√¥leur
            const params = new URLSearchParams({
                vehiculeId: vehiculeId,
                dateDebut: start,
                dateFin: end
            });
            window.location.href = `/reservation?${params.toString()}`;
        });
    </script>

</body>

</html>