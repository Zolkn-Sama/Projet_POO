<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location de v√©hicules</title>

    <!-- Tailwind CSS + DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <style>
        * {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }
    </style>
</head>

<body class="min-h-screen bg-base-200">

    <!-- NAVBAR -->
    <div class="navbar bg-base-100 shadow-sm px-4">
        <div class="flex-1">
            <a th:href="@{/}" class="btn btn-ghost text-xl font-bold">üöó EasyLoc</a>
        </div>
        <div class="flex-none gap-4">
            <div th:if="${isConnected}" class="flex items-center gap-4">
                <span class="text-sm">Bienvenue, <b th:text="${prenom}" class="text-primary"></b></span>

                <a th:if="${role == 'AGENT'}" th:href="@{/dashboard-agent}" class="btn btn-warning btn-sm">Espace
                    Agent</a>
                <a th:if="${role == 'LOUEUR'}" th:href="@{/dashboard-loueur}" class="btn btn-primary btn-sm">Mon
                    Profil</a>

                <button onclick="logout()" class="btn btn-ghost btn-sm text-error">D√©connexion</button>
            </div>

            <div th:unless="${isConnected}">
                <a th:href="@{/login}"
                    class="btn btn-ghost border-primary text-primary hover:bg-primary hover:text-white btn-sm rounded-full px-6">
                    Se connecter
                </a>
            </div>
        </div>
    </div>

    <!-- CONTENU PRINCIPAL -->
    <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">

        <!-- HERO -->
        <section class="hero bg-base-100 rounded-2xl shadow-xl border border-base-300">
            <div class="hero-content flex-col lg:flex-row gap-8">
                <div class="flex-1">
                    <h1 class="text-3xl lg:text-4xl font-extrabold">
                        Trouve le v√©hicule id√©al en quelques secondes
                    </h1>
                    <p class="py-4 text-base-content/70">
                        Choisis ta ville, tes dates et tes pr√©f√©rences. Nous t‚Äôaffichons
                        uniquement les v√©hicules <span class="font-semibold text-primary">disponibles</span>.
                    </p>

                    <div class="flex flex-wrap gap-2 text-sm">
                        <div class="badge badge-primary gap-1">
                            üîç Recherche filtr√©e
                        </div>
                        <div class="badge badge-secondary gap-1">
                            ‚úÖ Disponibilit√© en temps r√©el
                        </div>
                        <div class="badge badge-outline gap-1">
                            üë§ Agent & Loueur
                        </div>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="card bg-base-200 shadow-inner">
                        <div class="card-body">
                            <h2 class="card-title text-sm font-semibold text-base-content/70">
                                Connexion rapide
                            </h2>
                            <p class="text-sm text-base-content/60">
                                Acc√®de √† ton espace pour g√©rer tes locations.
                            </p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 pt-2">
                                <!-- Redirige vers /login si non connect√©, sinon vers dashboard -->
                                <a th:href="@{/quick/agent}" href="/quick/agent"
                                    class="btn btn-outline btn-sm justify-between">
                                    <span>Agent</span>
                                    <span class="badge badge-sm badge-info">Back-office</span>
                                </a>
                                <a th:href="@{/quick/loueur}" href="/quick/loueur"
                                    class="btn btn-primary btn-sm justify-between">
                                    <span>Loueur</span>
                                    <span class="badge badge-sm badge-accent">Client</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- GRILLE : FORMULAIRE + R√âSULTATS -->
        <section class="grid gap-6 lg:grid-cols-3 items-start">

            <!-- FORMULAIRE DE RECHERCHE -->
            <section class="lg:col-span-1">
                <div class="card bg-base-100 shadow-xl border border-base-300">
                    <div class="card-body space-y-4">
                        <h2 class="card-title text-lg">
                            Rechercher un v√©hicule
                        </h2>
                        <p class="text-sm text-base-content/60">
                            Remplis les filtres ci-dessous, puis lance la recherche.
                        </p>

                        <form id="search-form" class="space-y-4">

                            <div class="form-control">
                                <label for="ville" class="label">
                                    <span class="label-text">Ville</span>
                                </label>
                                <input id="ville" name="ville" type="text" placeholder="Ex : Lyon"
                                    class="input input-bordered input-sm w-full">
                            </div>

                            <div class="form-control">
                                <label for="noteMin" class="label">
                                    <span class="label-text">Note minimum</span>
                                    <span class="label-text-alt text-xs text-base-content/60">
                                        de 0 √† 5
                                    </span>
                                </label>
                                <input id="noteMin" name="noteMin" type="number" min="0" max="5" step="0.1"
                                    placeholder="Ex : 4.0" class="input input-bordered input-sm w-full">
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="form-control">
                                    <label for="dateDebut" class="label">
                                        <span class="label-text">Date de d√©but</span>
                                    </label>
                                    <input id="dateDebut" name="dateDebut" type="datetime-local"
                                        class="input input-bordered input-sm w-full">
                                </div>

                                <div class="form-control">
                                    <label for="dateFin" class="label">
                                        <span class="label-text">Date de fin</span>
                                    </label>
                                    <input id="dateFin" name="dateFin" type="datetime-local"
                                        class="input input-bordered input-sm w-full">
                                </div>
                            </div>

                            <!-- Options de CodeOption -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Options</span>
                                    <span class="label-text-alt text-xs text-base-content/60">
                                        (CodeOption)
                                    </span>
                                </label>
                                <div class="flex flex-wrap gap-2 text-sm">
                                    <!-- ‚ö†Ô∏è adapte les value selon ton enum CodeOption -->
                                    <label class="cursor-pointer flex items-center gap-2">
                                        <input type="checkbox" name="options" value="GPS"
                                            class="checkbox checkbox-xs checkbox-primary">
                                        <span>GPS</span>
                                    </label>
                                    <label class="cursor-pointer flex items-center gap-2">
                                        <input type="checkbox" name="options" value="CLIMATISATION"
                                            class="checkbox checkbox-xs checkbox-primary">
                                        <span>Climatisation</span>
                                    </label>
                                    <label class="cursor-pointer flex items-center gap-2">
                                        <input type="checkbox" name="options" value="AUTORADIO"
                                            class="checkbox checkbox-xs checkbox-primary">
                                        <span>Bo√Æte auto</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-control pt-2">
                                <button type="submit" class="btn btn-primary w-full">
                                    üîç Rechercher les v√©hicules
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- R√âSULTATS -->
            <section class="lg:col-span-2">
                <div class="card bg-base-100 shadow-xl border border-base-300">
                    <div class="card-body space-y-4">
                        <div class="flex items-center justify-between gap-2">
                            <h2 class="card-title text-lg">
                                R√©sultats de recherche
                            </h2>
                            <div id="result-count" class="text-xs text-base-content/60">
                                Aucun r√©sultat pour le moment.
                            </div>
                        </div>

                        <div id="results" class="space-y-3">
                            <div class="alert alert-info text-sm">
                                <span>
                                    Lance une recherche pour afficher les v√©hicules disponibles.
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </section>

        <footer class="pt-4 text-center text-xs text-base-content/50">
            Projet Java Spring Boot ‚Äì Location de v√©hicules
        </footer>
    </main>

    <script>
        const form = document.getElementById('search-form');
        const resultsDiv = document.getElementById('results');
        const resultCount = document.getElementById('result-count');

        form.addEventListener('submit', function (event) {
            event.preventDefault();
            const formData = new FormData(form);

            const filtre = {
                marque: formData.get('marque') || null,
                modele: formData.get('modele') || null,
                localisation: formData.get('ville') ? { ville: formData.get('ville') } : null,
                noteMin: parseFloat(formData.get('noteMin')) || 0,
                dateDebut: formData.get('dateDebut') || null,
                dateFin: formData.get('dateFin') || null,
                optionsRequises: formData.getAll('options') || []
            };

            fetch('/recherche/FilterVehicules', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filtre)
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Erreur HTTP : ' + res.status);
                    }
                    return res.json();
                })
                .then(vehicules => afficherVehicules(vehicules))
                .catch(err => {
                    console.error(err);
                    resultCount.textContent = 'Erreur lors du chargement.';
                    resultsDiv.innerHTML = `
                        <div class="alert alert-error">
                            <span>Une erreur est survenue lors du chargement des v√©hicules.</span>
                        </div>
                    `;
                });
        });

        function afficherVehicules(vehicules) {
            if (!vehicules || vehicules.length === 0) {
                resultCount.textContent = '0 v√©hicule trouv√©.';
                resultsDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <span>Aucun v√©hicule trouv√© pour ces crit√®res.</span>
                    </div>
                `;
                return;
            }

            resultCount.textContent = vehicules.length + ' v√©hicule(s) trouv√©(s).';

            // Liste verticale : 1 v√©hicule = 1 carte en largeur compl√®te
            let html = '<div class="space-y-3">';

            vehicules.forEach(v => {
                const car = v.caracteristiques || {};
                const marque = car.marque || v.marque || "Marque inconnue";
                const modele = car.modele || v.modele || "";
                const ville = (v.localisationVehicule && v.localisationVehicule.ville)
                    ? v.localisationVehicule.ville
                    : "N/A";

                const note = (typeof v.noteMoyenne === 'number') ? v.noteMoyenne.toFixed(1) : "0.0";
                const prix = (v.prixJournalier != null) ? v.prixJournalier : 30;

                // Une seule image par v√©hicule
                let imageUrl = '/ressources/img/default-car.jpeg'; // image par d√©faut √† cr√©er
                if (Array.isArray(v.photosURL) && v.photosURL.length > 0) {
                    const fragment = v.photosURL[0]; // ex: "/ressources/img/S1000RR_1.jpeg" ou "S1000RR_1.jpeg"
                    if (fragment.startsWith('/')) {
                        imageUrl = fragment;
                    } else {
                        imageUrl = '/ressources/img/' + fragment;
                    }
                } else if (v.imageUrl) {
                    imageUrl = v.imageUrl;
                }

                html += `
                    <div class="card card-side bg-base-100 border border-base-300 shadow-sm hover:shadow-md hover:border-primary transition-all">
                        <figure class="w-32 h-24 md:w-40 md:h-28 overflow-hidden bg-base-200">
                            <img src="${imageUrl}" alt="Photo du v√©hicule" class="w-full h-full object-cover" />
                        </figure>
                        <div class="card-body py-3 px-4 gap-2">
                            <div class="flex items-start justify-between gap-2">
                                <div>
                                    <h3 class="font-semibold text-sm md:text-base">
                                        ${marque} ${modele}
                                    </h3>
                                    <p class="text-xs text-base-content/70 mt-1">
                                        üìç <span class="font-medium">${ville}</span>
                                    </p>
                                </div>
                                <div class="flex flex-col items-end gap-1">
                                    <span class="badge badge-primary badge-sm">
                                        ${prix} ‚Ç¨/j
                                    </span>
                                    <span class="badge badge-ghost badge-sm">
                                        ‚≠ê ${note}
                                    </span>
                                </div>
                            </div>
                            <div class="flex justify-end pt-1">
                                <a href="/vehicule-detail?id=${v.id}" class="btn btn-primary btn-xs">
                                    Voir d√©tails
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => {
                    window.location.reload();
                })
                .catch(err => console.error("Erreur d√©connexion:", err));
        }
    </script>
</body>

</html>